# POST-DEPLOYMENT K8S TEST

The pipelines are capable of creating K8S environments over which "post-deployment" tests can be run. For post-deployment test is meant a test that implies the creation of one or more K8S-deployments and pods, including the one containing the image just-generated by the pipelines. These environment are usually called "preview-enviroments" and can be used to run from simple smoke tests to entire test suites.

# Evironment vars:

## Feature Flag

- `MTX-MVN-POST-DEPLOYMENT-TESTS`

## Execution Plan

- `ENTANDO_OPT_TEST_POSTDEP_PLAN`

### comma delimited list of these possible commands:

```
RESET-TEST-NAMESPACE                   => deletes and recreates the test namespaces
DEPLOY-PROJECT-HELM                    => deploys the project charts present in the project
DEPLOY-OPERATOR-CLUSTER-REQUIREMENTS   => deploys the cluster requirements of the given operator
DEPLOY-OPERATOR-NAMESPACE-REQUIREMENTS => deploys the namespace requirements of the given operator (except for the deployments)
DEPLOY-OPERATOR                        => deploys the operator in the test namespace (implies DEPLOY-OPERATOR-NAMESPACE-REQUIREMENTS)
RUN-POSTDEP-TESTS                      => runs the actual post-deployment tests
SUSPEND-TEST-NAMESPACE                 => scales to 0 all the deployments of the test namespace
DELETE-TEST-NAMESPACE                  => deletes the test namespace
```

## More..

Look for the ENTANDO_OPT_XXX vars in the below the placeholders table.


## Test Namespace

- `ENTANDO_OPT_TEST_NAMESPACE`

Namespace name to use to run the tests.
If set to `[auto]` tells the pipelies to derive it from the project name.


### Example for testing K8S controllers:

`RESET-TEST-NAMESPACE,DEPLOY-PROJECT-HELM,DEPLOY-OPERATOR-CLUSTER-REQUIREMENTS,DEPLOY-OPERATOR-NAMESPACE-REQUIREMENTS,RUN-TESTS,SUSPEND-TEST-NAMESPACE`

# About "DEPLOY-PROJECT-HELM"

this command contributes setting up the preview environment by running the chart contained in the project. It assume to find the charts starting file under this path:

- `./charts/preview/Chart.yaml`

Once found this it:

- Replaces of the handlebar placeholders on the designated chart files
- Updates the helm dependencies under `preview`
- Runs the template-based manifest generation under `preview`
- Applies the manifest to the connected K8S cluster


## The following are the supported placeholders:

| name | description |
| - | - | 
| ENTANDO_PROJECT_VERSION | the project version derived from the current pipelines execution context |
| ENTANDO_IMAGE_REPO | the docker repository determined by the docker-publication subsystem |
| ENTANDO_IMAGE_TAG | the docker image tag generated by the docker-publication subsystem |
| ENTANDO_OPT_TEST_NAMESPACE | the namespace to use to run the tests, generated by the pipelines if not provided |
| ENTANDO_OPT_IMAGE_REGISTRY_CREDENTIALS | the pull credentials to use incase the registry is authenticated |
| ENTANDO_OPT_IMAGE_REGISTRY_OVERRIDE | the image registry address to use |
| ENTANDO_OPT_TEST_HOSTNAME_SUFFIX | the host name suffix to assume when deriving the full hostname to use in tests |
| ENTANDO_OPT_TEST_TLS_CRT | the TLS cert to use when creating the test tls-secret and the ca-secret |
| ENTANDO_OPT_TEST_TLS_KEY | the TLS key to use when creating the test tls-secret |

## But note that the placeholders are only replaced on these files:

- `Charts.yaml`
- `values.yaml`
- `requirements.yaml`

of the immediate subdirs of the `./charts` directory
